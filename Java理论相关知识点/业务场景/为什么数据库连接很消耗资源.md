
## 为什么数据库连接很消耗资源？
> 消耗资源的分析主要集中在网络上，当然，资源也包括内存、CPU 等计算资源，使用的编程语言是 Java，
但是不排除编程语言也会有一定的影响。首先先看一下连接数据库的 Java 代码，如下：

```java
Class.forName("com.mysql.jdbc.Driver");

String name = "shine_user";
String password = "123";
String url = "jdbc:mysql://172.16.100.131:3306/clever_mg_test";
Connection conn = DriverManager.getConnection(url, name, password);
// 之后程序终止，连接被强制关闭，没有执行close()方法
// conn.close();
```
### &emsp;&emsp; 情况一：数据库连接没有执行close()方法，程序被强制终止    
- 1、MySQL 的通信协议是基于 TCP 传输协议的，而且该协议是二进制协议，不是类似于 HTTP 的文本协议。  
     > 其中建立连接的过程具体如下：  
      &emsp;&emsp;&emsp;&emsp;第 1 步：建立 TCP 连接，通过三次握手实现。  
      &emsp;&emsp;&emsp;&emsp;第 2 步：服务器发送给客户端「握手信息」，客户端响应该握手消息。  
      &emsp;&emsp;&emsp;&emsp;第 3 步：客户端「发送认证包」，用于用户验证，验证成功后，服务器返回 OK 响应，之后开始执行命令。


-  2、用户验证成功之后，会进行一些连接变量的设置，比如字符集、是否自动提交事务等，其间会有多次数据的交互。
      完成了这些步骤后，才会执行真正的数据查询和更新等操作。  
      在此次测试中，只用了 5 行代码来建立连接，但是并没有通过该连接去执行任何操作，
      所以在程序执行完毕之后，连接不是通过 Connection.close() 关闭的，而是由于程序执行完毕，
      导致进程终止，造成与数据库的连接异常关闭，所以最后会出现 TCP 的 RST 报文。
  

-  3、在这个最简单的代码中，没有设置任何额外的连接属性，所以在设置属性上占用的时间可以认为是最少的
    （其实，虽然我们没有设置任何属性，但是驱动仍然设置了字符集、事务自动提交等，这取决于具体的驱动实现），
     所以整个连接所使用的时间可以认为是最少的。
  

-  4、但从统计信息中可以看出，在不包括最后 TCP 的 RST 报文时（因为该报文不需要服务器返回任何响应），
      但是其中仍需在客户端和服务器之间进行往返「7」次，「也就是说完成一次连接，可以认为，数据在客户端和服务器之间需要至少往返 7 次」。
  

-  5、从时间上来看，从开始 TCP 的三次握手，到最终连接强制断开为止（不包括最后的 RST 报文），总共花费了：
     10.416042 - 10.190799 = 0.225243s = 225.243ms  
     这意味着，建立一次数据库连接需要 225ms，而这还是还可以认为是最少的，
     当然「花费的时间可能受到网络状况、数据库服务器性能以及应用代码是否高效的影响」，
     但是这里只是一个最简单的例子，已经足够说明问题了！



### &emsp;&emsp; 情况二：数据库连接执行close()方法
- 1、建立连接的过程具体如下
   > 第 1 步：此时处于 MySQL 通信协议阶段，客户端发送关闭连接请求，而且不用等待服务端的响应。  
     第 2 步：TCP 断开连接，4 次挥手完成连接断开。  


- 2、这里是完整地完成了从数据库连接的建立到关闭，整个过程花费了：747.284311 - 747.100954 = 0.183357s = 183.357ms  
     这里可能也有网络状况的影响，比上述的 225ms 少了，但是也几乎达到了 200ms 的级别。


- 3、那么问题来了，想象一下这个场景，对于一个日活 2 万的网站来说，假设每个用户只会发送 5 个请求，那么一天就是 10 万个请求。  
     对于建立数据库连接，我们保守一点计算为 150ms 好了，那么一天当中花费在建立数据库连接的时间有（还不包括执行查询和更新操作）：
     100000 * 150ms = 15000000ms = 15000s = 250min = 4.17h  
     也就说每天花费在建立数据库连接上的时间已经达到「4 个小时」，所以说数据库连接池是必须的嘛。

## 总结  
   &emsp;&emsp;&emsp;&emsp;我们想要阐述的核心思想只有一个，数据库连接真的很耗时，所以不要频繁的建立连接。


