## 一、CAP 理论

 <h3>
    <figure> 
       CAP 定理（CAP theorem）又被称作布鲁尔定理（Brewer’s theorem），是加州大学伯克利分校的计算机科学家埃里克·布鲁尔（Eric Brewer）在 2000 年的 ACM PODC 上提出的一个猜想。
       <br/>
       对于设计分布式系统的架构师来说，CAP 是必须掌握的理论。
    </figure>
 </h3>


 <h3>
    <figure> 
       在一个分布式系统中，当涉及读写操作时，只能保证一致性（Consistence）、可用性（Availability）、分区容错性（Partition Tolerance）
       三者中的两个，另外一个必须被牺牲。
    </figure>
 </h3>

- > #### C 一致性（Consistency）：对某个指定的客户端来说，读操作保证能够返回最新的写操作结果<br/>
- > #### A 可用性（Availability）：非故障的节点在合理的时间内返回合理的响应（不是错误和超时的响应）<br/>
- > #### P 分区容忍性（Partition Tolerance）：当出现网络分区后（可能是丢包，也可能是连接中断，还可能是拥塞），系统能够继续“履行职责”

---

## 二、cap理论P（分区容错）的理解

 <h3>
    分区：
    <figure> 
       一个分布式系统里面，节点组成的网络本来应该是连通的。然而可能因为一些故障，使得有些节点之间不连通了，整个网络就分成了几块区域。
       <br/>       
       数据就散布在了这些不连通的区域中。这就叫分区。    
    </figure>
 </h3>

 <h3>
    分区容错：
    <figure> 
       当你一个数据项只在一个节点中保存，那么分区出现后，和这个节点不连通的部分就访问不到这个数据了。这时分区就是无法容忍的。
       <br/>       
       提高分区容忍性的办法就是一个数据项复制到多个节点上，那么出现分区之后，这一数据项就可能分布到各个区里。容忍性就提高了。
       <br/>
       然而，要把数据复制到多个节点，就会带来一致性的问题，就是多个节点上面的数据可能是不一致的。要保证一致，每次写操作就都要等待全部节点写成功，而这等待又会带来可用性的问题。
    </figure>
 </h3>

 <h3>
    总结：
    <figure> 
       数据存在的节点越多，分区容忍性越高，但要复制更新的数据就越多，一致性就越难保证。为了保证一致性，更新所有节点数据所需要的时间就越长，可用性就会降低。
    </figure>
 </h3>

---

## 三、CAP特点

 <h3>
    <figure>
       在实际设计过程中，每个系统不可能只处理一种数据，而是包含多种类型的数据，有的数据必须选择 CP，有的数据必须选择 AP，
       分布式系统理论上不可能选择 CA 架构。
    </figure>
 </h3>

 <h4>
    CP：
    <figure>
       假设有两个节点 N1、N2，为了保证一致性，当发生分区现象后，N1 节点上的数据已经从 x 更新到 y，但由于 N1 和 N2 之间的复制通道中断，
       数据 y 无法从 N1 同步到 N2，N2 节点上的数据还是 x。这时客户端 C 访问 N2 时，N2 需要返回 Error， 提示客户端C “系统现在发生了错误”。
       <br/>
       这种处理方式违背了可用性（Availability）的要求，因此 CAP 三者只能满足 CP。
    </figure>
 </h4>

 <h4>
    AP：
    <figure>
       有两个节点 N1、N2，为了保证可用性，当发生分区现象后，N1 节点上的数据已经更新到 y，但由于 N1 和 N2 之间的复制通道中断，
       数据 y 无法同步到 N2，N2 节点上的数据还是 x。这时客户端 C 访问 N2 时，N2 将当前自己拥有的数据 x 返回给客户端 C 了，
       而实际上当前最新的数据已经是 y 了，这就不满足一致性（Consistency）的要求了，因此 CAP 三者只能满足 AP。
       <br/>
       注意：这里 N2 节点返回 x，虽然不是一个“正确”的结果，
            但是一个“合理”的结果，因为 x 是旧的数据，并不是一个错乱的值，只是不是最新的数据而已。
    </figure>
 </h4>

- ### CAP 理论中的 C 在实践中是不可能完美实现的，在数据复制的过程中，节点N1 和节点 N2 的数据并不一致（强一致性）。即使无法做到强一致性，但应用可以采用适合的方式达到最终一致性。具有如下特点：
    - ##### *基本可用（Basically Available）：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用。*
    - ##### *软状态（Soft State）：允许系统存在中间状态，而该中间状态不会影响系统整体可用性。这里的中间状态就是 CAP 理论中的数据不一致。*
    - ##### *最终一致性（Eventual Consistency）：系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。*
