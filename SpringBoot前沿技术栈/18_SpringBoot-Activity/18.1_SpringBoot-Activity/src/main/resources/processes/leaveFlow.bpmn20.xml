<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath"
             targetNamespace="http://www.activiti.org/processdef">
    <process id="leaveFlow" name="两级审批请假流程" isExecutable="true">
        <documentation>
            企业级两级串行审批请假流程：
            1. 支持事假/病假/调休三类请假类型；
            2. 一级审批（直属领导）、二级审批（部门总监/HR）串行执行；
            3. 每级审批24小时未处理触发超时提醒，提醒后回到原审批任务；
            4. 任意一级审批驳回后，发起人可重提或终止流程；
            5. 审批通过/发起人终止均触发流程正常结束。
        </documentation>
        <!-- 1. 流程开始 -->
        <startEvent id="startEvent" name="流程开始">
            <documentation>员工填写请假信息并提交，流程正式启动</documentation>
        </startEvent>
        <!-- 2. 一级审批任务（直属领导） -->
        <userTask id="approveTaskA" name="一级审批（直属领导）" activiti:assignee="${approverA}" activiti:candidateUsers="system">
            <documentation>直属领导审批请假申请，1天内处理超时自动提醒</documentation>
            <extensionElements>
                <activiti:taskListener event="create" class="com.example.listener.ApproveTaskCreateListener"/>
            </extensionElements>
        </userTask>
        <!-- 2.1 一级审批超时边界事件：监听approveTaskA的执行时长（边界事件 - 24小时超时定时器） -->
        <boundaryEvent id="timeoutEventA" name="一级审批超时提醒" attachedToRef="approveTaskA" cancelActivity="false">
            <!-- 明确不终止原任务，仅触发提醒 -->
            <documentation>当一级审批任务超过24小时未处理时，触发超时提醒逻辑</documentation>
            <timerEventDefinition>
                <!-- PT24H = 24小时（ISO 8601时间格式），可改为PT30M（30分钟）测试 -->
                <timeDuration>PT24H</timeDuration>
            </timerEventDefinition>
        </boundaryEvent>
        <!-- 2.2 超时后执行的提醒任务，发送提醒通知（如短信/邮件） -->
        <serviceTask id="timeoutRemindTaskA" name="一级审批超时提醒执行"
                     activiti:class="com.example.delegate.ApprovalTimeoutTask"
                     activiti:assignee="${approverA}"
                     activiti:candidateUsers="system">
            <documentation>调用超时提醒服务，向直属领导推送审批超时通知</documentation>
            <extensionElements>
                <activiti:field name="taskType" stringValue="FIRST_LEVEL_APPROVAL"/>
            </extensionElements>
        </serviceTask>
        <!-- 2.3 超时提醒后回到原审批任务（继续等待处理） -->
        <sequenceFlow id="flow_timeoutA" sourceRef="timeoutEventA" targetRef="timeoutRemindTaskA"/>
        <sequenceFlow id="flow_timeoutA_back" sourceRef="timeoutRemindTaskA" targetRef="approveTaskA"/>
        <!-- 3. 一级审批结果排他网关（判断通过/驳回） -->
        <exclusiveGateway id="gatewayA" name="一级审批结果判断"/>
        <!-- 4. 二级审批任务（部门总监/HR） -->
        <userTask id="approveTaskB" name="二级审批（部门总监/HR）" activiti:assignee="${approverB}" activiti:candidateUsers="system">
            <documentation>部门总监/HR审批（仅一级审批通过后触发），1天内处理超时自动提醒</documentation>
            <extensionElements>
                <activiti:taskListener event="create" class="com.example.listener.ApproveTaskCreateListener"/>
            </extensionElements>
        </userTask>
        <!-- 4.1 二级审批超时边界事件：监听approveTaskB的执行时长（边界事件 - 24小时超时定时器） -->
        <boundaryEvent id="timeoutEventB" name="二级审批超时提醒" attachedToRef="approveTaskB" cancelActivity="false">
            <documentation>当二级审批任务超过24小时未处理时，触发超时提醒逻辑</documentation>
            <timerEventDefinition>
                <timeDuration>PT24H</timeDuration>
            </timerEventDefinition>
        </boundaryEvent>
        <!-- 4.2 超时后执行的提醒任务 -->
        <serviceTask id="timeoutRemindTaskB" name="二级审批超时提醒执行"
                     activiti:class="com.example.delegate.ApprovalTimeoutTask"
                     activiti:assignee="${approverB}"
                     activiti:candidateUsers="system">
            <documentation>调用超时提醒服务，向部门总监/HR推送审批超时通知</documentation>
            <extensionElements>
                <activiti:field name="taskType" stringValue="SECOND_LEVEL_APPROVAL"/>
            </extensionElements>
        </serviceTask>
        <!-- 4.3 超时提醒后回到原审批任务 -->
        <sequenceFlow id="flow_timeoutB" sourceRef="timeoutEventB" targetRef="timeoutRemindTaskB"/>
        <sequenceFlow id="flow_timeoutB_back" sourceRef="timeoutRemindTaskB" targetRef="approveTaskB"/>
        <!-- 5. 二级审批结果排他网关（判断通过/驳回） -->
        <exclusiveGateway id="gatewayB" name="二级审批结果判断"/>
        <!-- 6. 驳回后发起人处理任务 -->
        <userTask id="initiator" name="申请驳回处理" activiti:assignee="${initiator}" activiti:candidateUsers="system">
            <documentation>审批驳回后，发起人可修改后重新提交或终止流程</documentation>
            <extensionElements>
                <activiti:taskListener event="create" class="com.example.listener.RejectTaskCreateListener"/>
            </extensionElements>
        </userTask>
        <!-- 7. 发起人操作选择网关 -->
        <exclusiveGateway id="gatewayInitiator" name="发起人操作选择"/>
        <!-- 8. 流程结束事件 -->
        <endEvent id="endEvent" name="审批结束">
            <documentation>流程正常结束（审批通过/发起人终止）</documentation>
        </endEvent>

        <!-- ===================== 流程连线规则（规范ID+补充注释+修复条件） ===================== -->
        <!-- 开始 → 一级审批 -->
        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="approveTaskA"/>
        <!-- 一级审批 → 一级审批结果网关 -->
        <sequenceFlow id="flow2" sourceRef="approveTaskA" targetRef="gatewayA"/>
        <!-- 一级审批通过 → 二级审批（条件：approvalResultA = approved） -->
        <sequenceFlow id="flow3" sourceRef="gatewayA" targetRef="approveTaskB">
            <conditionExpression xsi:type="tFormalExpression">${approvalResultA == 'approved'}</conditionExpression>
        </sequenceFlow>
        <!-- 一级审批驳回 → 发起人驳回处理（条件：approvalResultA != approved） -->
        <sequenceFlow id="flow4" sourceRef="gatewayA" targetRef="initiator">
            <conditionExpression xsi:type="tFormalExpression">${approvalResultA != 'approved'}</conditionExpression>
        </sequenceFlow>
        <!-- 二级审批 → 二级审批结果网关 -->
        <sequenceFlow id="flow5" sourceRef="approveTaskB" targetRef="gatewayB"/>
        <!-- 二级审批通过 → 流程结束（条件：approvalResultB = approved） -->
        <sequenceFlow id="flow6" sourceRef="gatewayB" targetRef="endEvent">
            <conditionExpression xsi:type="tFormalExpression">${approvalResultB == 'approved'}</conditionExpression>
        </sequenceFlow>
        <!-- 二级审批驳回 → 发起人驳回处理（条件：approvalResultB != approved） -->
        <sequenceFlow id="flow7" sourceRef="gatewayB" targetRef="initiator">
            <conditionExpression xsi:type="tFormalExpression">${approvalResultB != 'approved'}</conditionExpression>
        </sequenceFlow>
        <!-- 驳回处理任务 → 发起人操作选择网关 -->
        <sequenceFlow id="flow8" sourceRef="initiator" targetRef="gatewayInitiator"/>
        <!-- 打回发起人后 → 流程结束（也可改为回到开始事件，根据需求调整） -->
        <sequenceFlow id="flow9" sourceRef="gatewayInitiator" targetRef="endEvent">
            <conditionExpression xsi:type="tFormalExpression">${initiatorAction == 'end'}</conditionExpression>
        </sequenceFlow>
        <!-- 打回发起人后 → 重新提交到A审批（条件：initiatorAction = resubmit） -->
        <sequenceFlow id="flow10" sourceRef="gatewayInitiator" targetRef="approveTaskA">
            <conditionExpression xsi:type="tFormalExpression">${initiatorAction == 'resubmit'}</conditionExpression>
        </sequenceFlow>
    </process>

    <!-- ===================== 流程图可视化坐标 ===================== -->
    <bpmndi:BPMNDiagram id="BPMNDiagram_leaveFlow">
        <bpmndi:BPMNPlane bpmnElement="leaveFlow" id="BPMNPlane_leaveFlow">
            <!-- 开始事件 -->
            <bpmndi:BPMNShape id="shape_start" bpmnElement="startEvent">
                <omgdc:Bounds x="-200.0" y="-65.0" width="30.0" height="30.0"/>
            </bpmndi:BPMNShape>
            <!-- 一级审批任务 -->
            <bpmndi:BPMNShape id="shape_A" bpmnElement="approveTaskA">
                <omgdc:Bounds x="-100.0" y="-90.0" width="100.0" height="80.0"/>
            </bpmndi:BPMNShape>
            <!-- 一级审批超时边界事件 -->
            <bpmndi:BPMNShape id="timeoutA" bpmnElement="timeoutEventA">
                <omgdc:Bounds x="-37.3068" y="-89.077866" width="30.0" height="30.0"/>
            </bpmndi:BPMNShape>
            <!-- 一级审批超时提醒任务 -->
            <bpmndi:BPMNShape id="shape-remindA" bpmnElement="timeoutRemindTaskB">
                <omgdc:Bounds x="64.427155" y="-250.0" width="100.0" height="80.0"/>
            </bpmndi:BPMNShape>
            <!-- 一级审批结果网关 -->
            <bpmndi:BPMNShape id="shape_gatewayA" bpmnElement="gatewayA">
                <omgdc:Bounds x="84.427155" y="-65.0" width="30.0" height="30.0"/>
            </bpmndi:BPMNShape>
            <!-- 二级审批任务 -->
            <bpmndi:BPMNShape id="shape_B" bpmnElement="approveTaskB">
                <omgdc:Bounds x="195.34354" y="-90.0" width="100.0" height="80.0"/>
            </bpmndi:BPMNShape>
            <!-- 二级审批超时边界事件 -->
            <bpmndi:BPMNShape id="timeoutB" bpmnElement="timeoutEventB">
                <omgdc:Bounds x="258.8466" y="-87.92446" width="30.0" height="30.0"/>
            </bpmndi:BPMNShape>
            <!-- 二级审批超时提醒任务 -->
            <!-- 二级审批结果网关 -->
            <bpmndi:BPMNShape id="shape_gatewayB" bpmnElement="gatewayB">
                <omgdc:Bounds x="388.2445" y="-65.0" width="30.0" height="30.0"/>
            </bpmndi:BPMNShape>
            <!-- 驳回处理任务 -->
            <bpmndi:BPMNShape id="shape_reject" bpmnElement="initiator">
                <omgdc:Bounds x="195.34355" y="135.07385" width="100.0" height="80.0"/>
            </bpmndi:BPMNShape>
            <!-- 发起人操作选择网关 -->
            <bpmndi:BPMNShape id="shape_gateway_initiator" bpmnElement="gatewayInitiator">
                <omgdc:Bounds x="388.2445" y="160.07385" width="30.0" height="30.0"/>
            </bpmndi:BPMNShape>
            <!-- 结束事件 -->
            <bpmndi:BPMNShape id="shape_end" bpmnElement="endEvent">
                <omgdc:Bounds x="506.15283" y="-65.0" width="30.0" height="30.0"/>
            </bpmndi:BPMNShape>
            <!-- 连线：开始 → 一级审批 -->
            <bpmndi:BPMNEdge id="edge1" bpmnElement="flow1">
                <omgdi:waypoint x="-170.0" y="-50.0"/>
                <omgdi:waypoint x="-100.0" y="-50.0"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：一级审批 → 一级审批网关 -->
            <bpmndi:BPMNEdge id="edge2" bpmnElement="flow2">
                <omgdi:waypoint x="0.0" y="-50.0"/>
                <omgdi:waypoint x="84.427155" y="-50.0"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：A网关 → B审批 -->
            <bpmndi:BPMNEdge id="edge3" bpmnElement="flow3">
                <omgdi:waypoint x="114.427155" y="-50.0"/>
                <omgdi:waypoint x="195.34354" y="-50.0"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：一级审批网关 → 驳回处理 -->
            <bpmndi:BPMNEdge id="edge4" bpmnElement="flow4">
                <omgdi:waypoint x="99.427155" y="-35.0"/>
                <omgdi:waypoint x="99.427155" y="175.07385"/>
                <omgdi:waypoint x="195.34355" y="175.07385"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：二级审批 → 二级审批网关 -->
            <bpmndi:BPMNEdge id="edge5" bpmnElement="flow5">
                <omgdi:waypoint x="295.3435" y="-50.0"/>
                <omgdi:waypoint x="388.2445" y="-50.0"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：二级审批网关 → 结束 -->
            <bpmndi:BPMNEdge id="edge6" bpmnElement="flow6">
                <omgdi:waypoint x="418.2445" y="-50.0"/>
                <omgdi:waypoint x="506.15283" y="-50.0"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：二级审批网关 → 驳回处理 -->
            <bpmndi:BPMNEdge id="edge7" bpmnElement="flow7">
                <omgdi:waypoint x="403.2445" y="-35.0"/>
                <omgdi:waypoint x="403.2445" y="52.38726"/>
                <omgdi:waypoint x="245.34354" y="52.387257"/>
                <omgdi:waypoint x="245.34355" y="135.07385"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：驳回处理 → 发起人操作选择网关 -->
            <bpmndi:BPMNEdge id="edge8" bpmnElement="flow8">
                <omgdi:waypoint x="295.34357" y="175.07385"/>
                <omgdi:waypoint x="388.2445" y="175.07385"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：驳回处理的发起人网关 → 流程结束 -->
            <bpmndi:BPMNEdge id="edge9" bpmnElement="flow9">
                <omgdi:waypoint x="418.2445" y="175.07387"/>
                <omgdi:waypoint x="521.1528" y="175.07387"/>
                <omgdi:waypoint x="521.1528" y="-35.000004"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：驳回处理的发起人网关 → 一级审批 -->
            <bpmndi:BPMNEdge id="edge10" bpmnElement="flow10">
                <omgdi:waypoint x="403.2445" y="190.07384"/>
                <omgdi:waypoint x="403.2445" y="262.53693"/>
                <omgdi:waypoint x="-50.0" y="262.53693"/>
                <omgdi:waypoint x="-50.0" y="-10.0"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：一级审批超时边界事件 → 超时提醒任务 -->
            <bpmndi:BPMNEdge id="edge11" bpmnElement="flow_timeoutA">
                <omgdi:waypoint x="-7.306801" y="-74.077866"/>
                <omgdi:waypoint x="89.427155" y="-170.0"/>
            </bpmndi:BPMNEdge>
            <!-- 连线：二级审批超时边界事件 → 超时提醒任务 -->
            <bpmndi:BPMNEdge id="edge12" bpmnElement="flow_timeoutB">
                <omgdi:waypoint x="258.8466" y="-72.92446"/>
                <omgdi:waypoint x="144.42715" y="-169.99998"/>
            </bpmndi:BPMNEdge>
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
</definitions>
