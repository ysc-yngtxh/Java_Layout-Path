<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org/processdef">
  <process id="borrowArchive1" name="请假流程" isExecutable="true">
    <!-- 1. 流程开始 -->
    <startEvent id="startEvent" name="流程开始"/>
    <!-- 2. 第一级审批：A审批 -->
    <userTask id="approveTaskA" activiti:assignee="${approverA}" name="A审批" activiti:candidateUsers="system">
      <documentation>A作为第一审批人，审批请假申请</documentation>
    </userTask>
    <!-- 3. A审批结果排他网关（判断通过/驳回） -->
    <exclusiveGateway id="gatewayA" name="A审批结果"/>
    <!-- 4. 第二级审批：B审批 -->
    <userTask id="approveTaskB" activiti:assignee="${approverB}" name="B审批" activiti:candidateUsers="system">
      <documentation>B作为第二审批人，仅A通过后可见</documentation>
    </userTask>
    <!-- 5. B审批结果排他网关（判断通过/驳回） -->
    <exclusiveGateway id="gatewayB" name="B审批结果"/>
    <!-- 6. 打回提议人任务 -->
    <userTask id="rejectTask" activiti:assignee="${proposer}" name="申请打回" activiti:candidateUsers="system">
      <documentation>审批驳回后，打回给提议人修改/重新提交</documentation>
    </userTask>
    <!-- 7. 流程结束 -->
    <endEvent id="endEvent" name="审批结束"/>
    <!-- 流程连线规则 -->
    <!-- 开始 → A审批 -->
    <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="approveTaskA"/>
    <!-- A审批 → A审批结果网关 -->
    <sequenceFlow id="flow2" sourceRef="approveTaskA" targetRef="gatewayA"/>
    <!-- A审批通过 → B审批（条件：approvalResultA = approved） -->
    <sequenceFlow id="flow3" sourceRef="gatewayA" targetRef="approveTaskB">
      <conditionExpression xsi:type="tFormalExpression">${approvalResultA == 'approved'}</conditionExpression>
    </sequenceFlow>
    <!-- A审批驳回 → 打回提议人（条件：approvalResultA != approved） -->
    <sequenceFlow id="flow4" sourceRef="gatewayA" targetRef="rejectTask">
      <conditionExpression xsi:type="tFormalExpression">${approvalResultA != 'approved'}</conditionExpression>
    </sequenceFlow>
    <!-- B审批 → B审批结果网关 -->
    <sequenceFlow id="flow5" sourceRef="approveTaskB" targetRef="gatewayB"/>
    <!-- B审批通过 → 流程结束（条件：approvalResultB = approved） -->
    <sequenceFlow id="flow6" sourceRef="gatewayB" targetRef="endEvent">
      <conditionExpression xsi:type="tFormalExpression">${approvalResultB == 'approved'}</conditionExpression>
    </sequenceFlow>
    <!-- B审批驳回 → 打回提议人（条件：approvalResultB != approved） -->
    <sequenceFlow id="flow7" sourceRef="gatewayB" targetRef="rejectTask">
      <conditionExpression xsi:type="tFormalExpression">${approvalResultB != approved}</conditionExpression>
    </sequenceFlow>
    <!-- 打回提议人后 → 流程结束（也可改为回到开始事件，根据需求调整） -->
    <sequenceFlow id="flow8" sourceRef="rejectTask" targetRef="endEvent"/>
  </process>


  <!-- 流程图可视化坐标（调整后布局） -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_borrowArchive">
    <bpmndi:BPMNPlane bpmnElement="borrowArchive" id="BPMNPlane_borrowArchive">
      <!-- 开始事件 -->
      <bpmndi:BPMNShape id="shape_start" bpmnElement="startEvent">
        <omgdc:Bounds x="-200.0" y="-65.0" width="30.0" height="30.0"/>
      </bpmndi:BPMNShape>
      <!-- A审批任务 -->
      <bpmndi:BPMNShape id="shape_A" bpmnElement="approveTaskA">
        <omgdc:Bounds x="-100.0" y="-90.0" width="100.0" height="80.0"/>
      </bpmndi:BPMNShape>
      <!-- A审批网关 -->
      <bpmndi:BPMNShape id="shape_gatewayA" bpmnElement="gatewayA">
        <omgdc:Bounds x="84.427155" y="-65.0" width="30.0" height="30.0"/>
      </bpmndi:BPMNShape>
      <!-- B审批任务 -->
      <bpmndi:BPMNShape id="shape_B" bpmnElement="approveTaskB">
        <omgdc:Bounds x="195.34354" y="-90.0" width="100.0" height="80.0"/>
      </bpmndi:BPMNShape>
      <!-- B审批网关 -->
      <bpmndi:BPMNShape id="shape_gatewayB" bpmnElement="gatewayB">
        <omgdc:Bounds x="388.2445" y="-65.0" width="30.0" height="30.0"/>
      </bpmndi:BPMNShape>
      <!-- 打回提议人任务 -->
      <bpmndi:BPMNShape id="shape_reject" bpmnElement="rejectTask">
        <omgdc:Bounds x="195.34355" y="135.07385" width="100.0" height="80.0"/>
      </bpmndi:BPMNShape>
      <!-- 结束事件 -->
      <bpmndi:BPMNShape id="shape_end" bpmnElement="endEvent">
        <omgdc:Bounds x="506.15283" y="-65.0" width="30.0" height="30.0"/>
      </bpmndi:BPMNShape>
      <!-- 连线：开始→A审批 -->
      <bpmndi:BPMNEdge id="edge1" bpmnElement="flow1">
        <omgdi:waypoint x="-170.0" y="-50.0"/>
        <omgdi:waypoint x="-100.0" y="-50.0"/>
      </bpmndi:BPMNEdge>
      <!-- 连线：A审批→A网关 -->
      <bpmndi:BPMNEdge id="edge2" bpmnElement="flow2">
        <omgdi:waypoint x="0.0" y="-50.0"/>
        <omgdi:waypoint x="84.427155" y="-50.0"/>
      </bpmndi:BPMNEdge>
      <!-- 连线：A网关→B审批 -->
      <bpmndi:BPMNEdge id="edge3" bpmnElement="flow3">
        <omgdi:waypoint x="114.427155" y="-50.0"/>
        <omgdi:waypoint x="195.34354" y="-50.0"/>
      </bpmndi:BPMNEdge>
      <!-- 连线：A网关→打回 -->
      <bpmndi:BPMNEdge id="edge4" bpmnElement="flow4">
        <omgdi:waypoint x="99.427155" y="-35.0"/>
        <omgdi:waypoint x="99.427155" y="175.07385"/>
        <omgdi:waypoint x="195.34355" y="175.07385"/>
      </bpmndi:BPMNEdge>
      <!-- 连线：B审批→B网关 -->
      <bpmndi:BPMNEdge id="edge5" bpmnElement="flow5">
        <omgdi:waypoint x="295.3435" y="-50.0"/>
        <omgdi:waypoint x="388.2445" y="-50.0"/>
      </bpmndi:BPMNEdge>
      <!-- 连线：B网关→结束 -->
      <bpmndi:BPMNEdge id="edge6" bpmnElement="flow6">
        <omgdi:waypoint x="418.2445" y="-50.0"/>
        <omgdi:waypoint x="506.15283" y="-50.0"/>
      </bpmndi:BPMNEdge>
      <!-- 连线：B网关→打回 -->
      <bpmndi:BPMNEdge id="edge7" bpmnElement="flow7">
        <omgdi:waypoint x="403.2445" y="-35.0"/>
        <omgdi:waypoint x="403.2445" y="52.38726"/>
        <omgdi:waypoint x="245.34354" y="52.387257"/>
        <omgdi:waypoint x="245.34355" y="135.07385"/>
      </bpmndi:BPMNEdge>
      <!-- 连线：打回→结束 -->
      <bpmndi:BPMNEdge id="edge8" bpmnElement="flow8">
        <omgdi:waypoint x="295.34357" y="175.07385"/>
        <omgdi:waypoint x="521.1528" y="175.07385"/>
        <omgdi:waypoint x="521.1528" y="-35.000004"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
