<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" targetNamespace="http://www.activiti.org/processdef">
  <!-- 两级审批请假流程：支持事假/病假/调休，驳回后可重提或终止 -->
  <process id="leaveFlow" name="两级审批请假流程" isExecutable="true" activiti:initiator="initiator">
    <!-- 补充发起人变量声明，关联流程发起人 -->
    <documentation>
            企业级两级串行审批请假流程：
            1. 支持事假/病假/调休三类请假类型；
            2. 一级审批（直属领导）、二级审批（部门总监/HR）串行执行；
            3. 每级审批24小时未处理触发超时提醒，提醒后回到原审批任务；
            4. 任意一级审批驳回后，发起人可重提或终止流程；
            5. 审批通过/发起人终止均触发流程正常结束。
        </documentation>
    <!-- 流程开始：员工发起请假申请 -->
    <startEvent id="startEvent" name="流程开始">
      <documentation>员工填写请假信息并提交，流程正式启动</documentation>
    </startEvent>
    <!-- 一级审批：直属领导 -->
    <userTask id="approveTaskA" name="一级审批（直属领导）" activiti:assignee="${approverA}" activiti:candidateUsers="system">
      <documentation>直属领导审批请假申请，24小时内未处理触发自动提醒</documentation>
      <extensionElements>
        <activiti:taskListener event="create" class="com.example.listener.ApproveTaskCreateListener"/>
      </extensionElements>
    </userTask>
    <!-- 一级审批超时边界事件：监听approveTaskA的执行时长 -->
    <boundaryEvent id="timeoutEventA" name="一级审批超时提醒" attachedToRef="approveTaskA" cancelActivity="false">
      <!-- 明确不终止原任务，仅触发提醒 -->
      <documentation>当一级审批任务超过24小时未处理时，触发超时提醒逻辑</documentation>
      <timerEventDefinition>
        <timeDuration>PT24H</timeDuration>
        <!-- ISO 8601格式：24小时 -->
      </timerEventDefinition>
    </boundaryEvent>
    <!-- 一级审批超时提醒执行：发送提醒通知（如短信/邮件） -->
    <serviceTask id="timeoutRemindTaskA" name="一级审批超时提醒执行" activiti:class="com.example.delegate.TimeoutRemindService">
      <documentation>调用超时提醒服务，向直属领导推送审批超时通知</documentation>
      <extensionElements>
        <activiti:field name="taskType" stringValue="FIRST_LEVEL_APPROVAL"/>
      </extensionElements>
    </serviceTask>
    <!-- 二级审批：部门总监/HR -->
    <userTask id="approveTaskB" name="二级审批（部门总监/HR）" activiti:assignee="${approverB}" activiti:candidateUsers="system">
      <documentation>仅一级审批通过后触发，24小时内未处理触发自动提醒</documentation>
      <extensionElements>
        <activiti:taskListener event="create" class="com.example.listener.ApproveTaskCreateListener"/>
      </extensionElements>
    </userTask>
    <!-- 二级审批超时边界事件：监听approveTaskB的执行时长 -->
    <boundaryEvent id="timeoutEventB" name="二级审批超时提醒" attachedToRef="approveTaskB" cancelActivity="false">
      <documentation>当二级审批任务超过24小时未处理时，触发超时提醒逻辑</documentation>
      <timerEventDefinition>
        <timeDuration>PT24H</timeDuration>
      </timerEventDefinition>
    </boundaryEvent>
    <!-- 二级审批超时提醒执行：发送提醒通知 -->
    <serviceTask id="timeoutRemindTaskB" name="二级审批超时提醒执行" activiti:class="com.example.delegate.TimeoutRemindService">
      <documentation>调用超时提醒服务，向部门总监/HR推送审批超时通知</documentation>
      <extensionElements>
        <activiti:field name="taskType" stringValue="SECOND_LEVEL_APPROVAL"/>
      </extensionElements>
    </serviceTask>
    <!-- 排他网关：一级审批结果判断 -->
    <exclusiveGateway id="gatewayA" name="一级审批结果判断">
      <documentation>判断一级审批结果：通过/驳回</documentation>
    </exclusiveGateway>
    <!-- 排他网关：二级审批结果判断 -->
    <exclusiveGateway id="gatewayB" name="二级审批结果判断">
      <documentation>判断二级审批结果：通过/驳回</documentation>
    </exclusiveGateway>
    <!-- 排他网关：发起人操作选择（重提/终止） -->
    <exclusiveGateway id="gatewayInitiator" name="发起人操作选择">
      <documentation>发起人处理驳回申请：重提/终止流程</documentation>
    </exclusiveGateway>
    <!-- 申请驳回处理：发起人操作 -->
    <userTask id="rejectTask" name="申请驳回处理" activiti:assignee="${initiator}" activiti:candidateUsers="system">
      <documentation>审批驳回后，发起人可修改申请重新提交，或直接终止流程</documentation>
      <extensionElements>
        <activiti:taskListener event="create" class="com.example.listener.RejectTaskCreateListener"/>
      </extensionElements>
    </userTask>
    <!-- 流程结束 -->
    <endEvent id="endEvent" name="审批结束">
      <documentation>流程正常结束（审批通过/发起人终止）</documentation>
    </endEvent>
    <!-- 序列流：流程链路定义 -->
    <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="sid-c408c4f0-2937-4422-9123-89c4b460fc46"/>
    <sequenceFlow id="flow2" sourceRef="approveTaskA" targetRef="gatewayA"/>
    <!-- 一级审批通过：流向二级审批 -->
    <sequenceFlow id="flow3" sourceRef="gatewayA" targetRef="approveTaskB">
      <conditionExpression xsi:type="tFormalExpression">${approvalResultA == 'approved'}</conditionExpression>
    </sequenceFlow>
    <!-- 一级审批驳回：流向驳回处理 -->
    <sequenceFlow id="flow4" sourceRef="gatewayA" targetRef="rejectTask">
      <conditionExpression xsi:type="tFormalExpression">${approvalResultA != 'approved'}</conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow5" sourceRef="approveTaskB" targetRef="gatewayB"/>
    <!-- 二级审批通过：流程结束 -->
    <sequenceFlow id="flow6" sourceRef="gatewayB" targetRef="endEvent">
      <conditionExpression xsi:type="tFormalExpression">${approvalResultB == 'approved'}</conditionExpression>
    </sequenceFlow>
    <!-- 二级审批驳回：流向驳回处理 -->
    <sequenceFlow id="flow7" sourceRef="gatewayB" targetRef="rejectTask">
      <conditionExpression xsi:type="tFormalExpression">${approvalResultB != 'approved'}</conditionExpression>
    </sequenceFlow>
    <!-- 发起人终止流程：流程结束 -->
    <sequenceFlow id="flow8" sourceRef="gatewayInitiator" targetRef="endEvent">
      <conditionExpression xsi:type="tFormalExpression">${initiatorAction == 'end'}</conditionExpression>
    </sequenceFlow>
    <!-- 发起人重提申请：回到一级审批 -->
    <sequenceFlow id="flow9" sourceRef="gatewayInitiator" targetRef="approveTaskA">
      <conditionExpression xsi:type="tFormalExpression">${initiatorAction == 'resubmit'}</conditionExpression>
    </sequenceFlow>
    <!-- 驳回处理后指向发起人操作选择网关 -->
    <sequenceFlow id="flow10" sourceRef="rejectTask" targetRef="gatewayInitiator"/>
    <!-- 超时事件链路：一级审批超时→提醒→回到一级审批 -->
    <sequenceFlow id="flow_timeoutA" sourceRef="timeoutEventA" targetRef="timeoutRemindTaskA"/>
    <sequenceFlow id="flow_timeoutA_back" sourceRef="timeoutRemindTaskA" targetRef="approveTaskA"/>
    <!-- 超时事件链路：二级审批超时→提醒→回到二级审批 -->
    <sequenceFlow id="flow_timeoutB" sourceRef="timeoutEventB" targetRef="timeoutRemindTaskB"/>
    <sequenceFlow id="flow_timeoutB_back" sourceRef="timeoutRemindTaskB" targetRef="approveTaskB"/>
    <!-- 为排他网关补充默认流（避免无匹配条件时流程卡住） -->
    <sequenceFlow id="gatewayA_default" sourceRef="gatewayA" targetRef="rejectTask" isDefault="true"/>
    <sequenceFlow id="gatewayB_default" sourceRef="gatewayB" targetRef="rejectTask" isDefault="true"/>
    <sequenceFlow id="gatewayInitiator_default" sourceRef="gatewayInitiator" targetRef="endEvent" isDefault="true"/>
    <boundaryEvent id="sid-c408c4f0-2937-4422-9123-89c4b460fc46">
      <timerEventDefinition/>
    </boundaryEvent>
    <sequenceFlow id="sid-a48cf35b-b6f1-4670-b25a-d66bbf0a43f9" sourceRef="sid-c408c4f0-2937-4422-9123-89c4b460fc46" targetRef="approveTaskA"/>
  </process>
  <!-- BPMN可视化图形定义（坐标优化，保持布局不变） -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_leaveFlow">
    <bpmndi:BPMNPlane id="BPMNPlane_leaveFlow" bpmnElement="leaveFlow">
      <bpmndi:BPMNShape id="shape_start" bpmnElement="startEvent">
        <omgdc:Bounds x="-200" y="-65" width="30" height="30"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_A" bpmnElement="approveTaskA">
        <omgdc:Bounds x="-100" y="-90" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_gatewayA" bpmnElement="gatewayA" isMarkerVisible="true">
        <omgdc:Bounds x="84.427155" y="-65" width="30" height="30"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_B" bpmnElement="approveTaskB">
        <omgdc:Bounds x="195.34354" y="-90" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_gatewayB" bpmnElement="gatewayB" isMarkerVisible="true">
        <omgdc:Bounds x="388.2445" y="-65" width="30" height="30"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_reject" bpmnElement="rejectTask">
        <omgdc:Bounds x="195.34355" y="135.07385" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_gatewayInitiator" bpmnElement="gatewayInitiator" isMarkerVisible="true">
        <omgdc:Bounds x="320" y="160" width="30" height="30"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="shape_end" bpmnElement="endEvent">
        <omgdc:Bounds x="506.15283" y="-65" width="30" height="30"/>
      </bpmndi:BPMNShape>
      <!-- 序列流可视化链路 -->
      <bpmndi:BPMNEdge id="edge1" bpmnElement="flow1">
        <omgdi:waypoint x="-170" y="-50"/>
        <omgdi:waypoint x="-79.63755" y="-206.00217"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge2" bpmnElement="flow2">
        <omgdi:waypoint x="0" y="-50"/>
        <omgdi:waypoint x="84.427155" y="-50"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge3" bpmnElement="flow3">
        <omgdi:waypoint x="114.427155" y="-50"/>
        <omgdi:waypoint x="195.34354" y="-50"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge4" bpmnElement="flow4">
        <omgdi:waypoint x="99.427155" y="-35"/>
        <omgdi:waypoint x="99.427155" y="175.07385"/>
        <omgdi:waypoint x="195.34355" y="175.07385"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge5" bpmnElement="flow5">
        <omgdi:waypoint x="295.3435" y="-50"/>
        <omgdi:waypoint x="388.2445" y="-50"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge6" bpmnElement="flow6">
        <omgdi:waypoint x="418.2445" y="-50"/>
        <omgdi:waypoint x="506.15283" y="-50"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge7" bpmnElement="flow7">
        <omgdi:waypoint x="403.2445" y="-35"/>
        <omgdi:waypoint x="403.2445" y="52.38726"/>
        <omgdi:waypoint x="245.34354" y="52.387257"/>
        <omgdi:waypoint x="245.34355" y="135.07385"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge8" bpmnElement="flow8">
        <omgdi:waypoint x="350" y="160"/>
        <omgdi:waypoint x="521.1528" y="160"/>
        <omgdi:waypoint x="521.1528" y="-35"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge9" bpmnElement="flow9">
        <omgdi:waypoint x="320" y="190"/>
        <omgdi:waypoint x="320" y="262.53693"/>
        <omgdi:waypoint x="-50" y="262.53693"/>
        <omgdi:waypoint x="-50" y="-10"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge10" bpmnElement="flow10">
        <omgdi:waypoint x="295.34355" y="175.07385"/>
        <omgdi:waypoint x="320" y="175.07385"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="shape-c9470785-5194-4992-805c-3a9f4a4608f3" bpmnElement="sid-c408c4f0-2937-4422-9123-89c4b460fc46">
        <omgdc:Bounds x="-79.63755" y="-221.00217" width="30.0" height="30.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="edge-12cd1f7d-bbd0-4e5c-9ff2-2cf26b09a66f" bpmnElement="sid-a48cf35b-b6f1-4670-b25a-d66bbf0a43f9">
        <omgdi:waypoint x="-64.63756" y="-206.00217"/>
        <omgdi:waypoint x="-75.0" y="-90.0"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
