# DDD概览

在笔者学习DDD的过程中，大部分文章通常都是在谈DDD的概念，理论，诚然这些很重要，但DDD的读者大多还是习惯与传统开发的方式，而DDD的思想与传统开发模式大为不同，当大量的理论铺面而来的时候，难免觉得无从着力，本系列文章希望通过一个实际系统的DDD案例,让读者对DDD的落地有一定的认识，认识的同时也会产生新的疑问，带着这些疑问在回头去学习DDD的系统理论，相信能够对读者起到帮助。

文章聚焦在 DDD 战术设计层面，通过先对 DDD
的一些基础概念的介绍，在结合实际编码去看下这些概念如何在编码中落地，文章目前同源码一起发布在
Gitee , 尾部附上文章链接。

此章节希望读者对DDD有一些基本概念，在本章中不会深入到具体概念的细节，在《实现领域驱动设计》一书中DDD每个概念背后都有一套详细的设计原则，后续文章中我们将结合编码的同时将一些概念与读者一起描述。

## 什么是领域驱动设计?

领域驱动设计目前被大量的提及，那么什么是领域驱动设计呢？笔者在刚开始接触时被这个问题纠结了很久，随着持续的学习，搜索大家对DDD的总结，发现DDD很难用一句话简单的描述清楚，让读者可以理解其含义。因此关于这个问题的解释我们就稍微繁琐一点，在领域驱动设计中，领域可以理解为业务，领域专家就是对业务很了解的人，比如你想要做一个在线车票的售票系统，那么平时我们看到的售票员可能就是领域专家，在比如你已经在一个业务上做了5年研发了，经历了各种需求的迭代，讨论，你懂得比新来的产品，业务还多，那么你有可能就是你们公司的领域专家。领域驱动设计的核心就是与领域专家一起通过领域建模的方式去设计的我们的软件程序。

* 那么领域如何驱动设计？或者说业务如何驱动软件设计？

单纯聊这个问题很奇怪，我们平时开发不都是业务驱动的吗？是的，但仔细的琢磨一下我们的开发过程，你会发现其中的问题。我们在和业务（领域）专家讨论时,我们是想着将需求如何映射到代码上，还是想着应该创建那些表，改那些表字段才能满足需求呢？我们在拿到一个产品原型，需求清单第一步是写代码还是创建数据表呢？大多数时候答案是后者，因此我们实际是将面向业务开发转换为了面向数据开发。

那么DDD如何解决这个问题呢，答案是领域模型，我个人认为领域模型的核心是通过模型承载和保存领域知识，并通过模型与代码的映射将这些领域知识保存在程序代码中。在传统的开发中，当业务被转换为一张张数据表时，丢失最多的就是领域知识。

## DDD可以做什么

![DDD可以做什么](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/ddd-do-what.png)

DDD主要分为两个部分，战略设计与战术设计，战略设计围绕微服务拆分，战术设计围绕微服务构建

## DDD怎么做

![DDD怎么做](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/ddd-how-do.png)

1.
领域专家与研发人员一起（研发人员可能就是领域专家），通过一系列的方式方法（DDD并没有明确说明用什么方法），划分出业务的边界，这个边界就是限界上下文，微服务可以以限界上下文指定微服务的拆分，但是微服务的拆分并不是说一定以限界上下文为边界，这里面还需要考虑其它因数，比如3个火枪手原则、两个披萨原则以及组织架构对微服务拆分的影响等。
2.
研发人员通过领域模型，领域模型就是DDD中用于指定微服务实现的模型，保存领域知识，通过这种方式DDD通过领域模型围绕业务进⾏建模，并将模型与代码进⾏映射，业务调整影响代码的同时,代码也能直接的反映业务。

> 按照常规的编码⽅式,代码就不能直接反映业务了吗？ 请参考贫血模型与充血模型

[充血模型编码实践](https://gitee.com/izhengyin/ddd-message/blob/master/blog/DDD%E5%85%85%E8%A1%80%E6%A8%A1%E5%9E%8B%E7%BC%96%E7%A0%81%E5%AE%9E%E8%B7%B5.md)

## DDD领域模型

![DDD领域模型](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/ddd-model.png)

### 实体与值对象

![实体与值对象](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/entitiy-and-valueobject.png)

* 实体的特征

1. 唯一标识，对唯一性事物进行建模
2. 包含了业务的关键行为，可以随着业务持续变化
3. 修改时，因为有唯一标识，所以还是同一个实体

在上图中，订单就是一个实体，因为他有订单的唯一ID，通过它可以表示订单这个事务的唯一性，并且在订单的整个生命周期，随着业务订单也在不断的变化，创建订单到订单完成，订单状态在不断的变化，但是因为它们有唯一的订单ID，所以它们就是同一个实体。

* 值对象的特征

1. 描述事物的某个特征，通常作为实体属性存在
2. 创建后即不可变
3. 修改时，用另一个值对象予以替换

在上图中，订单商品就是一个值对象，因为在订单语境下，商品就是订单的一个特征，同时订单中的商品在订单创建的那一刻就会被"
快照"下来，如果商品的发生变化，比如价格从100元涨价到10000元，订单中的商品也不会同步去修改。
在此种业务语境下，订单商品就符合对值对象的描述，那么如果卖家修改订单中商品的价格怎么办呢，在DDD中通过覆盖的方式进行修改，而不是只修改一个价格属性。

除了订单商品外，收获地址也是一个值对象，那么收获地址可以是一个实体吗？
答案是可以的，当业务在收获地址管理的上下文语境里的时候，收获地址就是一个实体。

> 更多对实体特征的描述，可以参考《实现领域驱动设计》一书

### 领域服务

![domain-service](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/domain-service.png)

领域服务可以帮助我们分担实体的功能，承接部分业务逻辑，做一些实体不变处理的业务流程,它不是必须的。
在上图中，描述的是一个创建消息的领域服务，因为消息的实体中有用户的值对象，但是用户的信息通常在另一个限界上下文，也就是另一个微服务中，因此需要通过一些facade接口获取，如果把这些接口的调用防在领域实体
中就会导致实体过于臃肿，且也不必保持其独立性，因为它需要被类似于Spring这样的框架进行管理，依赖注入一些接口,因此通过领域服务进行辅助是一种很好的方式。

### 聚合

![aggregation](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/aggregation.png)

将实体和值对象在一致性边界之内组成聚合,使用聚合划分限界上下文(微服务)
内部的边界,聚合根做为一种特殊的实体，用于管理聚合内部的实体与值对象，并将自身暴露给外部进行引用。

![orderDDD-aggregation](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/orderDDD-aggregation.png)

比如在上图中描述的是一个订单聚合，在这个聚合中，它里面有两个实体，一个是订单一个是退货退款协议，显然退货退款协议应该依托于订单，但是它也符合实体的特征，因此被定义为实体。在此情况下，订单实体就是此聚合的聚合根。

#### 聚合的一致性边界

1. 生命周期的一致性，聚合对外的生命周期保持一致，聚合根生命周期结束，聚合的内部所有对象的生命周期也都应该结束。
2. 事务的一致性，这里的事务指的是数据库事务，每个数据库事务指包含一个聚合，不应该有垮聚合的事务

### 领域事件

![transaction](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/transaction.png)

领域事件表示领域中所发生的事情，通过领域事件可以实现微服务内的信息同步，同时也可以实现对外部系统的解耦。

如上图所示，聚合变更后创建领域事件，领域事件有两种方式进行发布。

1. 与聚合事务一起进行存储，比如存储进一个本地事件表，在由事件转发器转发到消息队列，这样保证的事件不会丢失。
2. 直接进行转发到消息队列，但是此时因为事件还未入口，因此需要在聚合事务与消息队列发布事件之间做XA的2PC事务提交，因为有2PC存在，通常性能不会太好。

> 除了向外部系统发布事件，限界上下文内部的多个聚合也可以通过一些本地事务发布器来进行事务的发布，比如Spring
> Event 或 EventBus等

### 资源库

![resource](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/resource.png)

资源库是保存聚合的地方，将聚合实例存放在资源库（Repository）中，之后再通过该资源库来获取相同的实例。

1. Save: 聚合对象由Repository的实现,转换为存储所支持的数据结构进行持久化
2. Find: 根据存储所支持的数据结构,由Repository的实现转换为聚合对象

### 应用服务

![application-service](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/application-service.png)

应用服务负责流程编排，它将要实现的功能委托给一个或多个领域对象来实现，本身只负责处理业务用例的执行顺序以及结果的拼装同时也可以在应用服务做些权限验证等工作。

## DDD编码实践系列文章

后面的文章中我们将结合项目的案例，围绕战术设计部分的知识点进行展开,看下如何将DDD的概念与实际代码相结合进行落地。

[DDD概览](https://gitee.com/izhengyin/ddd-message/blob/master/blog/DDD%E6%A6%82%E8%A7%88.md)

[DDD推荐的架构模式]( https://gitee.com/izhengyin/ddd-message/blob/master/blog/DDD%E6%8E%A8%E8%8D%90%E7%9A%84%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F.md)

[DDD充血模型编码实践]( https://gitee.com/izhengyin/ddd-message/blob/master/blog/DDD%E5%85%85%E8%A1%80%E6%A8%A1%E5%9E%8B%E7%BC%96%E7%A0%81%E5%AE%9E%E8%B7%B5.md)

[DDD电商消息系统编码实践（一）](https://gitee.com/izhengyin/ddd-message/blob/master/blog/DDD%E7%94%B5%E5%95%86%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A0%81%E5%AE%9E%E8%B7%B5%E4%B8%80.md)

[DDD电商消息系统编码实践（二）](https://gitee.com/izhengyin/ddd-message/blob/master/blog/DDD%E7%94%B5%E5%95%86%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A0%81%E5%AE%9E%E8%B7%B5%E4%BA%8C.md)

[DDD电商消息系统编码实践（三）](https://gitee.com/izhengyin/ddd-message/blob/master/blog/DDD%E7%94%B5%E5%95%86%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A0%81%E5%AE%9E%E8%B7%B5%E4%B8%89.md)

[DDD电商消息系统编码实践（四）](https://gitee.com/izhengyin/ddd-message/blob/master/blog/DDD%E7%94%B5%E5%95%86%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A0%81%E5%AE%9E%E8%B7%B5%E5%9B%9B.md)

[DDD电商消息系统编码实践（五）](https://gitee.com/izhengyin/ddd-message/blob/master/blog/DDD%E7%94%B5%E5%95%86%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A0%81%E5%AE%9E%E8%B7%B5%E4%BA%94.md)
