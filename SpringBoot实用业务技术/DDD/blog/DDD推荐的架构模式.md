# DDD推荐的架构模式

本章我们来聊一聊DDD推荐的架构模式，这些架构模式用于指导服务内的具体实现，对于服务内的逻辑分层，职能角色，依赖关系都有现实的指导意义。

## DDD分层

在一个典型的DDD分层架构中，分为用户界面层（Interfacce） , 应用层（Application）,
领域层（Domain) ，基础设施层 （Infrastructure）, 其中领域层是DDD分层架构中的核心，它是保存领域知识的地方。

分层架构的一个重要原则是：每层只能与位于其下方的层发生耦合。

在传统的DDD分层中，下图是他们的依赖关系。

![传统的DDD分层-来自《实现领域驱动设计》](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/traditional-layer.png)

>
如果读者没有使用过DDD可能对此理解不是很直观，可以将用户界面层想象为Controller,应用层与领域层想象为Service,基础设施层想象为Repository或者DAO，可能会好理解一些

可以看到，在传统的DDD分层架构中，基础层是被其它层所共同依赖的，它处于最底层，这可能导致重心偏移（想象一下在Service依赖DAO的场景)
,然而在DDD中领域层才是核心，因此要改变这种依赖。

如何改变这种依赖关系呢，在面向对象设计中有一种设计原则叫做依赖导致原则（
Dependence Inversion Principle，DIP)。
> DIP的定义为:

> 高层模块不应该依赖于底层模块，二者都应该依赖于抽象。

> 抽象不应该依赖于细节，细节应该依赖于抽象。

根据DIP改进以后的架构如下图所示。

![改进后的DDD分层-来自《实现领域驱动设计》](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/dip-traditional-layer.png)

改进后的DDD分层，将整个依赖过程反过来了，但实际上仅仅是反过来了这么简单吗？在DIP的理论中，高层模块与低层模块是不相互依赖的，他们都依赖于一个抽象，那么这么看来,模块之间就不在是一种强耦合的关系了。

比如，在DIP之前，领域层之间依赖于基础设施层。

![直接依赖](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/depend1.png)

改进后，他们后依赖于IUserRepository的抽象，抽象由基础层去实现，领域层并不关心如何实现。

![间接依赖](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/depend2.png)

由此各模块可以对内实现强内聚对外提供松耦合依赖。

## 六边形架构（端口适配器架构）

六边形架构，对于每种外界类型，都有一个适配器与之相对应。业务核心逻辑被包裹在内部，外界通过应用层API与内部进行交互，内部的实现无须关注外部的变化，更加聚焦。在这种架构下还可以轻易地开发用于测试的适配器。
同时六边形架构又名“端口适配器架构”,
这里的端口不一定指传统意义上的服务端口，可以理解为一种通讯方式，比如在一个服务中，我们可能会提供给用户浏览器的基于HTTP的通讯方式，提供给服务内部的基于RPC的通讯方式，以及基于MQ的通讯方式等，适配器指的是用于将端口输入转换为服务内部接口可以理解的输入。

![将不同的接入适配到内部接口](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/adapter.png)

刚才我们讨论的是外部向领域服务内部输入部分的端口+适配器模式，同时输出时也同样，比如当我们的要将领域对象进行存储时，我们知道有各种各样的存储系统，比如Mysql、ES、Mongo等，假如说我们可以抽象出一个适配器，用于适配不同的存储系统，那么我们就可以灵活的切换不同的存储介质，这对于我们开发测试，以及重构都是很有帮助的，而在DDD中这个抽象的适配器就资源库。

理解到这些以后，我们来看下六边形架构的整体架构。

![六边形架构](https://gitee.com/izhengyin/ddd-message/raw/master/blog/images/liubianxing2.png)

在此中架构下，业务层被聚焦在内部的六边形，内部的六边形不关心外部如何运作，只关注与内部的业务实现，这也是DDD推崇的方式，研发人员应该更关注于业务的实现也就是领域层的工作，而不是
聚焦在技术的实现。结合分层架构的思想，外部的六边形可以理解为接口层与基础层，内部理解为应用层与领域层，内部通过DIP与外部解耦。

> 在《实现领域驱动设计》一书中,作者认为它是一种具有持久生命力的架构。
